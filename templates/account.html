{% extends 'base.html' %}


<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   
    {% block body %}
    <style>
        /* Custom width for modal dialog */
        .custom-modal-width {
            max-width: 400px; /* Adjust as needed */
        }
        
        /* Center content and reduce padding */
        .modal-body {
            padding-left: 0rem; /* Reduce padding from left */
            padding-right: 0rem; /* Reduce padding from right */
        }
        
        /* Optional: Center the form content */
        #editAddressForm {
            margin: 0 auto;
        }
        
        /* Optional: Center the button */
        .modal-body .btn-primary {
            display: block;
            margin: 1rem auto;
        }
        
        
        /* Ensure proper spacing for the grid items */
        .modal-body .form-control,
        .modal-body .form-select {
            font-size: 0.875rem; /* Adjust font size for better fit */
        }
        
        /* Adjust address details textarea to be smaller */
        .modal-body textarea#modalAddressDetails {
            height: auto; /* Allow dynamic height adjustment */
            resize: vertical; /* Allow vertical resizing */
        }
        
     
        /* Sidebar */
        .sidebar {
            background: #f8f9fa;
            padding: 20px;
        }
        
        /* Profile Section */
        .profile-section {
            text-align: center;

        }
        
        .profile-picture img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Address Book Styles */
        .address-block {
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            position: relative;
        }
        
        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .address-actions {
            display: flex;
            align-items: center;
        }
        
        .address-actions a {
            color: #007bff;
            text-decoration: none;
            font-size: 1.2rem;
            margin-left: 10px;
        }
        
        .address-actions a:hover {
            color: #0056b3;
        }
        
        /* Form Styles */
        .edit-address-form {
            margin-top: 10px;
        }
        
        .edit-address-form .form-control {
            margin-bottom: 10px;
        }
        
        
      

        .content {
            padding: 15px;
        }
        .section-heading {
            cursor: pointer;
        }
        .section-content {
            display: none;
        }
        
        .active-section {
            font-weight: bold;
            background-color: #e9ecef;
        }
    </style>
</head>
{% block chatbot %}
{% endblock chatbot %}
    {% block content %}
{% endblock content %}
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="profile-section">
                    <div class="profile-picture">
                        <img src="{% static 'avatar-transformed.png' %}" alt="Profile Picture">
                    </div>
                    <h3>{{ user.username }}</h3>
                </div>
                
                <div class="list-group mt-3">
                    <a href="#" class="list-group-item list-group-item-action section-heading active-section" data-target="profile">Profile</a>
                    <a href="#" class="list-group-item list-group-item-action section-heading" data-target="coupon-section">My coupons</a>
                    <a href="#" class="list-group-item list-group-item-action section-heading" data-target="my-orders">My orders</a>
                    <a href="#" class="list-group-item list-group-item-action section-heading" data-target="address-book">Address Book</a>
                    <a href="#" class="list-group-item list-group-item-action section-heading" data-target="transaction-history">Transaction History</a>
                    <a href="#" class="list-group-item list-group-item-action section-heading" data-target="wishlist">Wishlist</a>
                    <a href="#" class="list-group-item list-group-item-action section-heading" data-target="faq">FAQ</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 content">
               <!-- Profile Section -->
<div id="profile" class="section-content" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 30px; max-width: 600px; margin: 0 auto;">
    <h4 class="mb-4" style="font-size: 1.5rem; font-weight: 600;">Profile Details</h4>
    <form style="display:block;">
        <div class="form-group mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" value="{{ user.username }}" disabled>
        </div>
        <div class="form-group mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" value="{{ user.email }}">
        </div>
        <div class="form-group mb-4">
            <div class="input-group">
                <span class="input-group-text">+91</span>
                <input type="text" style="color:black;" id="phone" name="phone" placeholder="{% trans 'Phone *' %}" required class="form-control" value="{{ user.phone }}">
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Save Changes</button>
    </form>
</div>

                    <!-- FAQ Section -->
                   <!-- FAQ Section -->
                   <div id="faq" class="section-content" style="margin-top: 20px; padding: 20px; background-color: #ffffff; border-radius: 5px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                    <h4>Frequently Asked Questions</h4>
                    <div class="accordion" id="faqAccordion">
                        <div class="card">
                            <div class="card-header" id="headingOne">
                                <h5 class="mb-0">
                                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        What is the return policy?
                                    </button>
                                </h5>
                            </div>
                
                            <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#faqAccordion">
                                <div class="card-body">
                                    Our return policy allows for returns within 30 days of purchase. Please ensure the item is in its original condition.
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header" id="headingTwo">
                                <h5 class="mb-0">
                                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        How do I track my order?
                                    </button>
                                </h5>
                            </div>
                            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#faqAccordion">
                                <div class="card-body">
                                    You can track your order by logging into your account and visiting the 'Orders' section. 
                                </div>
                            </div>
                        </div>
                
                        <div class="card">
                            <div class="card-header" id="headingThree">
                                <h5 class="mb-0">
                                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                        Can I change my delivery address after placing an order?
                                    </button>
                                </h5>
                            </div>
                            <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#faqAccordion">
                                <div class="card-body">
                                    Unfortunately, once an order is placed, you cannot change the delivery address. Please contact our support team for further assistance.
                                </div>
                            </div>
                        </div>
                
                        <div class="card">
                            <div class="card-header" id="headingFour">
                                <h5 class="mb-0">
                                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                        What payment methods do you accept?
                                    </button>
                                </h5>
                            </div>
                            <div id="collapseFour" class="collapse" aria-labelledby="headingFour" data-parent="#faqAccordion">
                                <div class="card-body">
                                    We accept all major credit cards, debit cards, and PayPal. You can also choose to pay using net banking or UPI.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
 <!-- Coupon Section -->
<div id="coupon-section" class="section-content">
    <h4>Available Coupons</h4>
    <div class="row">
        {% for coupon in coupons %}
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Coupon: <span class="coupon-code">{{ coupon.code }}</span></h5>
                        <p class="card-text">Discount: ${{ coupon.discount_amount }}</p>
                        <p class="card-text">Valid Till: {{ coupon.expiration_date }}</p>
                        <p class="card-text"><small class="text-muted">T&Cs apply</small></p>
                        <button class="copy-btn btn btn-primary" data-clipboard-text="{{ coupon.code }}">Copy Code</button>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <p>No coupons available.</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Bootstrap Toast Notification -->
<div aria-live="polite" aria-atomic="true" class="position-relative">
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="copy-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Coupon Code</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        Coupon code copied to clipboard!
      </div>
    </div>
  </div>
</div>

                <!-- Order History Section -->
                <div id="my-orders" class="section-content">
                    <h4>My Orders</h4>
                    <a href="{% url 'my_orders' %}" class="btn btn-primary">View My Orders</a>
                    <!-- Recent orders summary or details here -->
                </div>
 <!-- Address Book Section -->
<!-- Manage Addresses -->
<div id="address-book" class="section-content container-fluid" style="background-color: #f8f9fa; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
    <h4 class="mb-4">Manage Addresses</h4>

    <div class="row">
        <!-- Address Form -->
        <div class="col-md-6">
            <form id="addressForm" data-url="{% url 'save_address' %}" style="width: 100%; max-width: 100%; margin: 0 auto; display: block;">
                {% csrf_token %}

                <div class="form-group">
                    <label for="addressType" class="font-weight-bold">Address Type</label>
                    <select class="form-control" id="addressType" name="address_type">
                        <option value="billing">Billing Address</option>
                        <option value="delivery">Delivery Address</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="addressDetails" class="font-weight-bold">Address Details</label>
                    <textarea class="form-control" id="addressDetails" name="address_details" rows="4" placeholder="Enter address details"></textarea>
                </div>

                <div class="form-group">
                    <label for="location" class="font-weight-bold">Location</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="location" id="locationIndore" value="Indore">
                            <label class="form-check-label" for="locationIndore">Indore</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="location" id="locationShivpuri" value="Shivpuri">
                            <label class="form-check-label" for="locationShivpuri">Shivpuri</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="postcode" class="font-weight-bold">Postcode</label>
                    <input type="text" class="form-control" id="postcode" name="postcode" placeholder="Enter postcode">
                </div>

                <input type="hidden" id="addressId" name="address_id" value=""> <!-- Hidden field for editing -->

                <div class="text-right mt-3">
                    <button type="button" id="saveButton" class="btn btn-primary">Save Address</button>
                </div>
            </form>
        </div>

        <!-- Saved Addresses -->
        <div class="col-md-6">
            <div id="savedAddresses" class="mt-4">
                <h5 class="font-weight-bold">Saved Addresses</h5>
        
                {% if saved_addresses %}
                {% for address in saved_addresses %}
                <div class="address-item" data-id="{{ address.id }}" data-type="{{ address.address_type }}" data-details="{{ address.address_details }}" data-location="{{ address.location }}" data-postcode="{{ address.postcode }}" style="border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
                    <p><strong>Address Type:</strong> <span class="badge badge-info">{{ address.address_type }}</span></p>
                    <p><strong>Address:</strong> {{ address.address_details }}</p>
                    <p><strong>Location:</strong> {{ address.location }}</p>
                    <p><strong>Postcode:</strong> {{ address.postcode }}</p>
                    <button class="btn btn-secondary btn-sm edit-button" data-id="{{ address.id }}">Edit</button>
                    <button class="btn btn-danger btn-sm delete-button ml-2" data-id="{{ address.id }}">
                        <i class="fa fa-trash"></i> Delete
                    </button>
                </div>
                {% endfor %}
                {% else %}
                    <p>No saved addresses found.</p>
                {% endif %}
            </div>
        </div>
        
    </div>
</div>

<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered custom-modal-width">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editAddressForm" data-url="{% url 'save_address' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" id="modalAddressId" name="address_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modalAddressType" class="form-label">Address Type</label>
                            <select class="form-select" id="modalAddressType" name="address_type">
                                <option value="billing">Billing Address</option>
                                <option value="delivery">Delivery Address</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="modalAddressDetails" class="form-label">Address Details</label>
                            <textarea class="form-control" id="modalAddressDetails" name="address_details" rows="3" placeholder="Enter address details"></textarea>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="location" id="modalLocationShivpuri" value="Shivpuri">
                                <label class="form-check-label" for="modalLocationShivpuri">Shivpuri</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="location" id="modalLocationIndore" value="Indore">
                                <label class="form-check-label" for="modalLocationIndore">Indore</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalPostcode" class="form-label">Postcode</label>
                        <input type="text" class="form-control" id="modalPostcode" name="postcode" placeholder="Enter postcode">
                    </div>
                    
                    <button type="button" id="modalSaveButton" class="btn btn-primary">Save Address</button>
                </div>
            </form>
        </div>
    </div>
</div>




                <!-- Transaction History Section -->
                <div id="transaction-history" class="section-content">
                    <h4>Transaction History</h4>
                    <!-- Transaction details here -->
                </div>

                <!-- Wishlist Section -->
                <div id="wishlist" class="section-content">
                    <h4>Wishlist</h4>
                    <!-- Wishlist items list here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
           
            // Section toggling functionality
            var sections = document.querySelectorAll('.section-heading');
            sections.forEach(function (section) {
                section.addEventListener('click', function (e) {
                    e.preventDefault();
        
                    var targetId = this.getAttribute('data-target');
        
                    // Hide all sections
                    document.querySelectorAll('.section-content').forEach(function (content) {
                        content.style.display = 'none';
                    });
        
                    // Remove active class from all links
                    sections.forEach(function (sec) {
                        sec.classList.remove('active-section');
                    });
        
                    // Show the selected section
                    document.getElementById(targetId).style.display = 'block';
        
                    // Add active class to clicked link
                    this.classList.add('active-section');
                });
            });
        
            // Trigger the first section to be visible by default
            if (sections.length > 0) {
                sections[0].click();
            }
        
   // Modal elements
// Modal elements
const editAddressModal = new bootstrap.Modal(document.getElementById('editAddressModal'));
const modalForm = document.getElementById('editAddressForm');
const modalSaveButton = document.getElementById('modalSaveButton');
const modalAddressId = document.getElementById('modalAddressId');
const modalAddressType = document.getElementById('modalAddressType');
const modalAddressDetails = document.getElementById('modalAddressDetails');
const modalPostcode = document.getElementById('modalPostcode');
const savedAddressesContainer = document.getElementById('savedAddresses');

// Main form elements for creating a new address
const form = document.getElementById('addressForm');
const saveButton = document.getElementById('saveButton');
const addressIdInput = document.getElementById('addressId');

// Function to populate the modal for editing
function populateModal(address) {
    modalAddressType.value = address.address_type;
    modalAddressDetails.value = address.address_details;
    
    // Set the correct radio button for location
    const locationRadios = document.querySelectorAll('input[name="modalLocation"]');
    locationRadios.forEach(radio => {
        if (radio.value === address.location) {
            radio.checked = true;
        }
    });

    modalPostcode.value = address.postcode;
    modalAddressId.value = address.id;  // Set the ID for editing
    modalSaveButton.textContent = 'Update Address';  // Change button text for editing
}

// Handle address item clicks to open the edit modal
savedAddressesContainer.addEventListener('click', function(event) {
    if (event.target.classList.contains('edit-button')) {
        const addressId = event.target.dataset.id;
        
        // Find the address item element
        const addressItem = event.target.closest('.address-item');
        const addressType = addressItem.dataset.type;
        const addressDetails = addressItem.dataset.details;
        const location = addressItem.dataset.location;
        const postcode = addressItem.dataset.postcode;
        
        populateModal({
            id: addressId,
            address_type: addressType,
            address_details: addressDetails,
            location: location,
            postcode: postcode
        });
        
        editAddressModal.show();  // Show the modal
    }
});

/// Handle saving address from the modal
modalSaveButton.addEventListener('click', function() {
    const formData = new FormData(modalForm);
    
    // Get the selected location from the radio buttons
    const selectedLocation = document.querySelector('input[name="modalLocation"]:checked');
    formData.set('location', selectedLocation ? selectedLocation.value : '');

    // Check if editing and add address ID to form data
    if (modalAddressId.value) {
        formData.append('address_id', modalAddressId.value);
    }
    
    fetch(modalForm.getAttribute('data-url'), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response from server:', data);  // Debug line
        
        if (data.success) {
            savedAddressesContainer.innerHTML = '';  // Clear current addresses
            data.savedAddresses.forEach(function(address) {
                savedAddressesContainer.innerHTML += `
                    <div class="address-item" data-id="${address.id}" data-type="${address.address_type}" data-details="${address.address_details}" data-location="${address.location}" data-postcode="${address.postcode}" style="border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
                        <p><strong>${address.address_type}</strong>: ${address.address_details}</p>
                        <p><strong>Location:</strong> ${address.location}</p>
                        <p><strong>Postcode:</strong> ${address.postcode}</p>
                        <button class="btn btn-secondary btn-sm edit-button" data-id="${address.id}">Edit</button>
                    </div>
                `;
            });
            editAddressModal.hide();  // Hide the modal
            modalForm.reset();  // Clear the modal form fields
            modalAddressId.value = '';  // Reset address ID
            modalSaveButton.textContent = 'Save Address';  // Reset button text
        } else {
            alert('Failed to save the address: ' + data.message);
        }
    })
    .catch(error => console.error('Error:', error));  // Debug line
});

// Handle deleting an address
document.querySelectorAll('.delete-button').forEach(button => {
    button.addEventListener('click', function() {
        const addressId = this.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this address?')) {
            fetch(`/delete_address/${addressId}/`, { // Adjust URL as necessary
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Address deleted successfully!');
                    location.reload(); // Refresh the page or update the address list
                } else {
                    alert('Failed to delete address.');
                }
            });
        }
    });
});

// Handle saving a new address
saveButton.addEventListener('click', function() {
    const formData = new FormData(form);
    
    // Get the selected location from the radio buttons in the main form
    const selectedLocation = document.querySelector('input[name="location"]:checked');
    formData.set('location', selectedLocation ? selectedLocation.value : '');
    
    // Check if editing and add address ID to form data
    if (addressIdInput.value) {
        formData.append('address_id', addressIdInput.value);
    }
    
    fetch(form.getAttribute('data-url'), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response from server:', data);  // Debug line
        
        if (data.success) {
            alert(data.message);  // Notify user of successful save
            location.reload();  // Reload the page to update the list of saved addresses
        } else {
            alert('Failed to save the address: ' + data.message);
        }
    })
    .catch(error => console.error('Error:', error));  // Debug line
});
var clipboard = new ClipboardJS('.copy-btn');

clipboard.on('success', function(e) {
    var toast = new bootstrap.Toast(document.getElementById('copy-toast'));
    toast.show();
});

clipboard.on('error', function(e) {
    var toast = new bootstrap.Toast(document.getElementById('copy-toast'));
    toast.show();
});
        });
        
    </script>
    
    

    {% endblock body %}


